---
cip: 99
title: Core Coin HD-Wallet scheme
author: @todesstille
lang: en-US
tag: draft
category: crc
date: 2022-06-16
---

### Abstract

The following standard defines HD-wallet derivation scheme

### Motivation

Since classical BIP32 scheme is not compatible with Ed448, this standard defines a bit different implementation of HD-derivation, based on revised CoreCoin cryptography mechanism.

### Specification

## Definitions
```
|| concatenation
+ usual sum of two numbers
+++ sum of two points on Ed448
H(x, salt) - 57 bytes of hash function HMAC-SHA512 with 2048 cycles of pbkdf2: PBKDF2(HMAC-SHA512, x, salt, 57, 2048))
chain, privKey, publicKey [57]byte
```
## Extended keys

Extended key is a [114]byte array. It is obtained by chaincode || privateKey or chaincode || publicKey. Since only Scheme1 supports HD-wallet derivation, so all private keys have the most significant bit of the last byte == 1. Details could be obtained from "Core Coin cryptography scheme" CIP

## Master key

Master key is the root of HD-derivation tree, and can be get from the mnemonics using slightly modified BIP39 scheme. You should follow this scheme until you get seed = BIP39 Seed, and then get master key by:
```
chain = H(seed, "mnemonicforthechain")
key = H(seed, "mnemonicforthekey")
masterKey = chain || key
```
Finally, for security reasons you should:
```
set the most significant bit of the last byte to 1 (masterKey[113] |= 0x80)
set the most significant bit of the next-to-last byte to 1 (masterKey[112] |= 0x80)
set the second significant bit of the next-to-last byte to 0 (masterKey[112] &= 0xbf)
```
Master key is exactly the "m" from "m/44'/..." derivation path.

## Child pair generation: chain code

Note, that you could always could pubKey from privKey. We will denote this operation as private2public

Generation of child chaincode is different for usual and hardened keys. For generation of usual key:
```
pubKey = private2public(privKey)
childChain = H(0x03 || pubKey || i , chain), i < 2^31
```
In case of generation hardened key:
```
childChain = H(0x01 || privKey || i , chain), i >= 2^31
```
## Child pair generaion: private key 2 private key

Generation of child private key is also different for usual and hardened keys. In case of usual key:
```
pubKey = private2public(privKey)
template = H(0x02 || pubKey || i , chain), i < 2^31
```
In case of hardened key:
```
template = H(0x00 || privKey || i , chain), i >= 2^31
```
Now we nullify the high 4 bytes and last 2 bit of the template. This is a security requirement. Let the
result be clampedTemplate = clamp(template). Then we calculate child privKey as:
```
childPrivKey = privKey + clampedTemplate
```
Note, that overflow will not happen due to high bytes of template setted to 0.
The EdDSA security standards require the 9th bit of privateKey to be == 1, to avoid rho-attacks. So we
clamped the template, because we want to add it to ptivateKey, and we want the 9th bit of the result to
remain secure. Since we nullified 32 bits, so 23 bits after 9th are zeroes, and we could do at least 2^22
operations of adding to privateKey. This limits the hierarchy level of the tree to, say, 2^20

## Child pair generaion: private key 2 public key

Public keys are generated by privatetKey2privateKey generation, and then deriving public from privateKey as
usual.

## Child pair generaion: public key 2 public

It is impossible to generate child public key from public hardened key. At fa—Åt, this is the main property
of hardened keys. They are constructed to make such derivation impossible.
Usual child public keys could be derived from usual parent public key:
At first we calculate clampedTemplate as above:
```
template = H(0x02 || publicKey || i , chain), i < 2^31
template -> clampedTemplate
```
Then we calculate a point on Ed448, corresponding to clampedTemplate and add it to publicKey (using
point addition for Ed448):
```
point = private2public(clampedTemplate)
childPublicKey = publicKey +++ point
```
This public key correspondents to private key, generated by private2private method

### Rationale

This scheme was made to provide alternative between classical Ed448 signature mechanism and the possibility to generate HD-wallet keys in BIP32-like-way. 

## Copyright
Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
